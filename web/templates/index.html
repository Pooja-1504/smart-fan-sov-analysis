<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Share of Voice Analysis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .progress-container { margin: 20px 0; }
        .results-card { margin: 15px 0; }
        .metric-card { text-align: center; padding: 20px; }
        .loading { display: none; }
        .hero-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px 0; margin-bottom: 30px; }
        .metric-card h4 { font-size: 2.5rem; margin-bottom: 10px; }
    </style>
</head>
<body>
    <!-- Hero Section -->
    <div class="hero-section">
        <div class="container text-center">
            <h1 class="display-4">üéØ Share of Voice Analysis</h1>
            <p class="lead">AI-powered competitive intelligence for smart fan market</p>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-12">
                <!-- Configuration Panel -->
                <div class="card mb-4 shadow">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">‚öôÔ∏è Analysis Configuration</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Keywords (one per line)</label>
                                <textarea id="keywords" class="form-control" rows="4" placeholder="smart fan&#10;BLDC fan&#10;energy saving fan"></textarea>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Platforms</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="platform-google" checked>
                                    <label class="form-check-label">üîç Google Search</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="platform-youtube" checked>
                                    <label class="form-check-label">üì∫ YouTube</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Max Results per Keyword</label>
                                <input type="number" id="max-results" class="form-control" value="30" min="5" max="50">
                                <small class="text-muted">5-50 results per keyword</small>
                            </div>
                        </div>
                        <div class="mt-4 d-flex align-items-center">
                            <button id="start-analysis" class="btn btn-success btn-lg me-3">
                                üöÄ Start Analysis
                            </button>
                            <span id="api-status" class="badge bg-secondary fs-6">Checking API keys...</span>
                        </div>
                    </div>
                </div>

                <!-- Progress Panel -->
                <div id="progress-panel" class="card mb-4 shadow loading">
                    <div class="card-body">
                        <h5 class="mb-3">‚è≥ Analysis in Progress...</h5>
                        <div class="progress mb-3" style="height: 25px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 0%"></div>
                        </div>
                        <div id="progress-status" class="text-center fw-bold">Initializing...</div>
                    </div>
                </div>

                <!-- Results Panel -->
                <div id="results-panel" class="loading">
                    <!-- Executive Summary -->
                    <div class="card results-card shadow">
                        <div class="card-header bg-success text-white">
                            <h3 class="mb-0">üìä Executive Summary</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 metric-card border-end">
                                    <h4 id="sov-metric" class="text-primary">-</h4>
                                    <p class="fw-bold text-muted">Share of Voice</p>
                                </div>
                                <div class="col-md-3 metric-card border-end">
                                    <h4 id="sopv-metric" class="text-success">-</h4>
                                    <p class="fw-bold text-muted">Share of Positive Voice</p>
                                </div>
                                <div class="col-md-3 metric-card border-end">
                                    <h4 id="rank-metric" class="text-warning">-</h4>
                                    <p class="fw-bold text-muted">Average Search Rank</p>
                                </div>
                                <div class="col-md-3 metric-card">
                                    <h4 id="position-metric" class="text-info">-</h4>
                                    <p class="fw-bold text-muted">Competitive Position</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div class="card results-card shadow">
                        <div class="card-header bg-warning text-dark">
                            <h3 class="mb-0">üí° Key Recommendations</h3>
                        </div>
                        <div class="card-body">
                            <ul id="recommendations-list" class="list-group list-group-flush">
                                <!-- Recommendations will be populated here -->
                            </ul>
                        </div>
                    </div>

                    <!-- Data Summary -->
                    <div class="card results-card shadow">
                        <div class="card-header bg-info text-white">
                            <h3 class="mb-0">üìà Analysis Summary</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>üìÑ Documents Analyzed:</strong> <span id="total-docs" class="badge bg-primary">-</span></p>
                                    <p><strong>üè∑Ô∏è Brand Mentions:</strong> <span id="total-mentions" class="badge bg-success">-</span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>üåê Platforms:</strong> <span id="platforms-analyzed" class="badge bg-info">-</span></p>
                                    <p><strong>üîë Keywords:</strong> <span id="keywords-analyzed" class="badge bg-warning text-dark">-</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Analyses -->
                <div class="card shadow">
                    <div class="card-header bg-dark text-white">
                        <h3 class="mb-0">üìù Recent Analyses</h3>
                    </div>
                    <div class="card-body">
                        <div id="recent-analyses" class="table-responsive">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading recent analyses...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light mt-5 py-4">
        <div class="container text-center">
            <p class="text-muted mb-0">
                ü§ñ AI-powered Share of Voice Analysis Tool | 
                Built for competitive intelligence in smart fan market
            </p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentAnalysisId = null;
        let progressTimer = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            loadRecentAnalyses();
            
            document.getElementById('start-analysis').addEventListener('click', startAnalysis);
        });

        function loadConfig() {
            fetch('/api/config')
                .then(response => response.json())
                .then(data => {
                    const status = document.getElementById('api-status');
                    if (data.api_keys_configured) {
                        status.textContent = '‚úÖ API Keys Configured';
                        status.className = 'badge bg-success fs-6';
                    } else {
                        status.textContent = '‚ùå API Keys Missing';
                        status.className = 'badge bg-danger fs-6';
                        document.getElementById('start-analysis').disabled = true;
                    }
                    
                    // Set default keywords
                    document.getElementById('keywords').value = data.default_keywords.join('\n');
                })
                .catch(error => {
                    console.error('Error loading config:', error);
                    const status = document.getElementById('api-status');
                    status.textContent = '‚ö†Ô∏è Server Error';
                    status.className = 'badge bg-warning fs-6';
                });
        }

        function startAnalysis() {
            const keywords = document.getElementById('keywords').value.split('\n').filter(k => k.trim());
            const platforms = [];
            if (document.getElementById('platform-google').checked) platforms.push('google');
            if (document.getElementById('platform-youtube').checked) platforms.push('youtube');
            const maxResults = parseInt(document.getElementById('max-results').value);

            if (keywords.length === 0) {
                alert('‚ö†Ô∏è Please enter at least one keyword');
                return;
            }

            if (platforms.length === 0) {
                alert('‚ö†Ô∏è Please select at least one platform');
                return;
            }

            const data = { keywords, platforms, max_results: maxResults };

            // Disable button during analysis
            const button = document.getElementById('start-analysis');
            button.disabled = true;
            button.innerHTML = '‚è≥ Starting...';

            fetch('/api/start-analysis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.analysis_id) {
                    currentAnalysisId = result.analysis_id;
                    showProgressPanel();
                    startProgressTracking();
                } else {
                    alert('‚ùå Error starting analysis: ' + result.error);
                    resetButton();
                }
            })
            .catch(error => {
                console.error('Error starting analysis:', error);
                alert('‚ùå Network error starting analysis');
                resetButton();
            });
        }

        function resetButton() {
            const button = document.getElementById('start-analysis');
            button.disabled = false;
            button.innerHTML = 'üöÄ Start Analysis';
        }

        function showProgressPanel() {
            document.getElementById('progress-panel').style.display = 'block';
            document.getElementById('results-panel').style.display = 'none';
            // Scroll to progress panel
            document.getElementById('progress-panel').scrollIntoView({ behavior: 'smooth' });
        }

        function startProgressTracking() {
            progressTimer = setInterval(checkProgress, 2000); // Check every 2 seconds
        }

        function checkProgress() {
            if (!currentAnalysisId) return;

            fetch(`/api/analysis/${currentAnalysisId}/status`)
                .then(response => response.json())
                .then(data => {
                    const progressBar = document.getElementById('progress-bar');
                    const progressStatus = document.getElementById('progress-status');
                    
                    progressBar.style.width = data.progress + '%';
                    
                    let statusText = '';
                    switch(data.status) {
                        case 'starting': statusText = 'üöÄ Initializing analysis...'; break;
                        case 'running': statusText = '‚öôÔ∏è Processing data...'; break;
                        case 'completed': statusText = '‚úÖ Analysis completed!'; break;
                        case 'error': statusText = '‚ùå Analysis failed'; break;
                        default: statusText = `Status: ${data.status}`;
                    }
                    progressStatus.textContent = `${statusText} (${data.progress}%)`;

                    if (data.status === 'completed') {
                        clearInterval(progressTimer);
                        hideProgressPanel();
                        loadResults(data.results);
                        loadRecentAnalyses(); // Refresh recent analyses
                        resetButton();
                    } else if (data.status === 'error') {
                        clearInterval(progressTimer);
                        hideProgressPanel();
                        alert('‚ùå Analysis failed: ' + data.error);
                        resetButton();
                    }
                })
                .catch(error => {
                    console.error('Error checking progress:', error);
                });
        }

        function hideProgressPanel() {
            document.getElementById('progress-panel').style.display = 'none';
        }

        function loadResults(results) {
            // Update metrics
            const keyMetrics = results.key_metrics || {};
            document.getElementById('sov-metric').textContent = (keyMetrics.overall_sov || 0).toFixed(1) + '%';
            document.getElementById('sopv-metric').textContent = (keyMetrics.overall_sopv || 0).toFixed(1) + '%';
            document.getElementById('rank-metric').textContent = (keyMetrics.average_search_rank || 0).toFixed(1);
            document.getElementById('position-metric').textContent = keyMetrics.competitive_position || 'Unknown';

            // Update recommendations
            const recList = document.getElementById('recommendations-list');
            recList.innerHTML = '';
            const recommendations = results.recommendations || [];
            
            if (recommendations.length === 0) {
                const li = document.createElement('li');
                li.className = 'list-group-item text-muted';
                li.textContent = 'No specific recommendations generated.';
                recList.appendChild(li);
            } else {
                recommendations.forEach((rec, index) => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex align-items-start';
                    li.innerHTML = `
                        <span class="badge bg-primary rounded-pill me-2">${index + 1}</span>
                        <span>${rec}</span>
                    `;
                    recList.appendChild(li);
                });
            }

            // Update summary
            document.getElementById('total-docs').textContent = results.total_documents || 0;
            document.getElementById('total-mentions').textContent = results.total_mentions || 0;
            document.getElementById('platforms-analyzed').textContent = (results.platforms_analyzed || []).join(', ');
            document.getElementById('keywords-analyzed').textContent = (results.keywords_analyzed || []).join(', ');

            document.getElementById('results-panel').style.display = 'block';
            // Scroll to results
            document.getElementById('results-panel').scrollIntoView({ behavior: 'smooth' });
        }

        function loadRecentAnalyses() {
            fetch('/api/recent-analyses')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('recent-analyses');
                    if (data.length === 0) {
                        container.innerHTML = '<p class="text-center text-muted">üìù No recent analyses found. Run your first analysis above!</p>';
                        return;
                    }

                    let html = `
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>üìÖ Date</th>
                                    <th>üè¢ Brand</th>
                                    <th>üìä SoV</th>
                                    <th>üèÜ Position</th>
                                    <th>üì• Action</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    data.forEach(analysis => {
                        const date = analysis.date;
                        const formattedDate = `${date.substr(0,4)}-${date.substr(4,2)}-${date.substr(6,2)}`;
                        const sov = typeof analysis.sov === 'number' ? analysis.sov.toFixed(1) : '0.0';
                        
                        html += `<tr>
                            <td>${formattedDate}</td>
                            <td><span class="badge bg-info">${analysis.target_brand}</span></td>
                            <td><strong>${sov}%</strong></td>
                            <td>${analysis.position}</td>
                            <td><a href="/api/download/${analysis.filename}" class="btn btn-sm btn-outline-primary">üì• Download</a></td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading recent analyses:', error);
                    document.getElementById('recent-analyses').innerHTML = '<p class="text-center text-danger">‚ö†Ô∏è Error loading recent analyses</p>';
                });
        }
    </script>
</body>
</html>
